<html>
    <head>
        <script type="text/javascript" src="src/renderer.js"></script>
        <script type="text/javascript" src="src/Action.js"></script>
        <script type="text/javascript" src="src/Animation.js"></script>
        <script type="text/javascript" src="src/TicTacToe.js"></script>
        <script type="text/javascript" src="src/RandomAI.js"></script>
        <script type="text/javascript" src="src/util.js"></script>
        <script type="text/javascript">
            var game = null;
            var actions = [];
            var field = [
                [0, 0 ,0],
                [0, 0 ,0],
                [0, 0 ,0]
            ];

            var resetField = function() {
                field = [
                    [0, 0 ,0],
                    [0, 0 ,0],
                    [0, 0 ,0]
                ];

            };

            window.addEventListener('load', function() {
                var canvas = document.querySelector('canvas.viewport');
                var ctx = canvas.getContext('2d');
                var renderer = Renderer(ctx);
                var screenToWorld = util.getScreenToWorld(100, 15)

                game = TicTacToe();
                var ai = RandomAI();


                renderer.render(field);

                var interfaceDisabled = false;
                canvas.addEventListener('mouseup', function(e) {

                    if (game.isOver()) {
                        game = TicTacToe();
                        resetField();
                        renderer.render(field);
                        return;

                    }
                    if (interfaceDisabled) {
                        return;
                    }

                    var coord = {
                        x : e.pageX - canvas.offsetLeft,
                        y : e.pageY - canvas.offsetTop
                    };

                    var space = screenToWorld(coord.x, coord.y);


                    if (space !== null) {
                        var row = space[0];
                        var col = space[1];

                        if (game.getField()[row][col] !== 0) {
                            return;
                        }

                        var action = game.put([row, col]);
                        actions = actions.concat(action);

                        if (!game.isOver()) {
                            interfaceDisabled = true;
                            setTimeout(function() {
                                var action = ai.move(game);
                                actions = actions.concat(action);


                                renderer.render(field);
                                interfaceDisabled = false;
                            }, 300);
                        };

                        renderer.render(field);
                    }
                });

                var direction = -1;


                var lastTime = new Date().getTime();
                var lastActionMade = lastTime;
                var render = function() {
                    var currTime = new Date().getTime();
                    var delta = currTime - lastTime;

                    renderer.actions.forEach(function(line, row) {
                        line.forEach(function(space, col) {
                            if(space == null) {
                                return;
                            }

                            var animation = space;
                            
                            if(animation.inProgress()) {
                                animation.tick(delta);
                            }
                            else {
                                renderer.actions[row][col] = null;
                            }
                        });
                    });

                    var actionDelta = currTime - lastActionMade;
                    if (actions.length !== 0 && actionDelta > 500) {
                        var action = actions.shift();

                        if (action.isPresent()) {
                            var row = action.get().space[0];
                            var col = action.get().space[1];
                            var token = action.get().token;
                            var result = action.get().result;

                            field[row][col] = token;

                            renderer.actions[row][col] = Animation({
                                length : 200,
                                onEnd: function() {
                                    if (result == 'victory') {
                                        game.getField().forEach(function(line, row) {
                                            line.forEach(function(space, col) {
                                                field[row][col] = space;
                                            });
                                        });
                                    }
                                }
                            });
                            lastActionMade = currTime;
                        }
                    }

                    renderer.render(field);
                    window.requestAnimationFrame(render);
                    lastTime = currTime;
                };

                window.requestAnimationFrame(render);

            });
        </script>
	<style type="text/css">
	.flex-container {
		height: 96%;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	</style>
    </head>
	<body class="flex-container">
        <canvas class="viewport" width="345" height="345"></canvas>
    </body>
</html>

