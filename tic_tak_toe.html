<html>
    <head>
        <script type="text/javascript" src="src/renderer.js"></script>
        <script type="text/javascript" src="src/Action.js"></script>
        <script type="text/javascript" src="src/Animation.js"></script>
        <script type="text/javascript" src="src/TicTacToe.js"></script>
        <script type="text/javascript" src="src/RandomAI.js"></script>
        <script type="text/javascript" src="src/util.js"></script>
        <script type="text/javascript">
            var renderer;
            var game = null;
            var actions = [];

            var resetField = function() {
                renderer.reset();

            };

            window.addEventListener('load', function() {
                var canvas = document.querySelector('canvas.viewport');
                var ctx = canvas.getContext('2d');
                renderer = Renderer(ctx);
                var screenToWorld = util.getScreenToWorld(100, 15)

                game = TicTacToe();
                var ai = RandomAI();

                var interfaceDisabled = false;
                canvas.addEventListener('mouseup', function(e) {

                    if (game.isOver()) {
                        game = TicTacToe();
                        resetField();
                        return;

                    }
                    if (interfaceDisabled) {
                        return;
                    }

                    var coord = {
                        x : e.pageX - canvas.offsetLeft,
                        y : e.pageY - canvas.offsetTop
                    };

                    var space = screenToWorld(coord.x, coord.y);


                    if (space !== null) {
                        var row = space[0];
                        var col = space[1];

                        if (game.getField()[row][col] !== 0) {
                            return;
                        }

                        var action = game.put([row, col]);
                        actions = actions.concat(action);

                        if (!game.isOver()) {
                            interfaceDisabled = true;
                            setTimeout(function() {
                                var action = ai.move(game);
                                actions = actions.concat(action);

                                interfaceDisabled = false;
                            }, 300);
                        };
                    }
                });

                var direction = -1;


                var lastTime = new Date().getTime();
                var lastActionMade = lastTime;
                var render = function() {
                    var currTime = new Date().getTime();
                    var delta = currTime - lastTime;

                    renderer.actions.forEach(function(line, row) {
                        line.forEach(function(animation, col) {
                            if (animation === null) {
                                return;
                            }
                            if(animation.inProgress()) {
                                animation.tick(delta);
                            }
                            else {
                                renderer.actions[row][col] = null;
                            }
                        });
                    });

                    var actionDelta = currTime - lastActionMade;

                    if (actions.length !== 0 && actionDelta > 500) {
                        var action = actions.shift();

                        if (action.isPresent()) {
                            var act = action.get();

                            var animations = renderer.actionToAnimations(action.get());

                            animations.forEach(function(animation) {
                                var row = animation.space[0];
                                var col = animation.space[1];

                                renderer.actions[row][col] = animation.animation;
                            });

                            lastActionMade = currTime;
                        }
                    }

                    renderer.render();
                    window.requestAnimationFrame(render);
                    lastTime = currTime;
                };

                window.requestAnimationFrame(render);

            });
        </script>
	<style type="text/css">
	.flex-container {
		height: 96%;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	</style>
    </head>
	<body class="flex-container">
        <canvas class="viewport" width="345" height="345"></canvas>
    </body>
</html>

