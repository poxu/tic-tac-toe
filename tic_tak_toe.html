<html>
    <head>
        <script type="text/javascript" src="src/renderer.js"></script>
        <script type="text/javascript" src="src/Action.js"></script>
        <script type="text/javascript" src="src/TicTacToe.js"></script>
        <script type="text/javascript" src="src/RandomAI.js"></script>
        <script type="text/javascript" src="src/util.js"></script>
        <script type="text/javascript">
            var game = null;
            window.addEventListener('load', function() {
                var canvas = document.querySelector('canvas.viewport');
                var ctx = canvas.getContext('2d');
                var renderer = Renderer(ctx);
                var screenToWorld = util.getScreenToWorld(100, 15)

                game = TicTacToe();
                var ai = RandomAI();


                renderer.render(game);

                var interfaceDisabled = false;
                canvas.addEventListener('mouseup', function(e) {

                    if (game.isOver()) {
                        game = TicTacToe();
                        renderer.render(game);
                        return;

                    }
                    if (interfaceDisabled) {
                        return;
                    }

                    var coord = {
                        x : e.pageX - canvas.offsetLeft,
                        y : e.pageY - canvas.offsetTop
                    };

                    var space = screenToWorld(coord.x, coord.y);


                    if (space !== null) {
                        var row = space[0];
                        var col = space[1];

                        if (game.getField()[row][col] !== 0) {
                            return;
                        }

                        var action = game.put([row, col]);

                        if(action.isPresent()) {
                            renderer.actions[row][col] = 0;
                        }

                        if (!game.isOver()) {
                            interfaceDisabled = true;
                            setTimeout(function() {
                                var action = ai.move(game);

                                if(action.isPresent()) {
                                    var row = action.get().space[0];
                                    var col = action.get().space[1];
                                    renderer.actions[row][col] = 0;
                                }

                                renderer.render(game);
                                interfaceDisabled = false;
                            }, 300);
                        };

                        renderer.render(game);
                    }
                });

                var direction = -1;


                var lastTime = new Date().getTime();
                var render = function() {
                    var currTime = new Date().getTime();
                    var delta = currTime - lastTime;

                    renderer.actions.forEach(function(line, row) {
                        line.forEach(function(space, col) {
                            if(space == null) {
                                return;
                            }

                            if(space > 300) {
                                renderer.actions[row][col] = null;
                            }
                            else {
                                renderer.actions[row][col] += delta;
                            }
                        });
                    });

                    renderer.render(game);
                    window.requestAnimationFrame(render);
                    lastTime = currTime;
                };

                window.requestAnimationFrame(render);

            });
        </script>
	<style type="text/css">
	.flex-container {
		height: 96%;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	</style>
    </head>
	<body class="flex-container">
        <canvas class="viewport" width="345" height="345"></canvas>
    </body>
</html>

